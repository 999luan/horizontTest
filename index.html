<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Horizont IA - Consultor Virtual</title>
    
    <!-- Bibliotecas -->
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* Reset e Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }
        
        html {
            height: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
            -webkit-font-smoothing: antialiased;
        }
        
        /* App Container */
        .app {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* Header Mobile */
        .header-mobile {
            height: 56px;
            background: linear-gradient(135deg, #1e3a5f 0%, #0d1929 100%);
            display: flex;
            align-items: center;
            padding: 0 16px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .menu-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            padding: 8px;
            margin-right: 12px;
            cursor: pointer;
        }
        
        .header-title {
            flex: 1;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            color: #10a37f;
        }
        
        .header-action {
            background: none;
            border: none;
            color: #10a37f;
            font-size: 22px;
            padding: 8px;
            cursor: pointer;
        }
        
        /* Sidebar */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .sidebar {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background: #0d1117;
            z-index: 2000;
            transition: left 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 12px rgba(0,0,0,0.5);
        }
        
        .sidebar.open {
            left: 0;
        }
        
        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #1e3a5f 0%, #0d1929 100%);
            border-bottom: 1px solid #30363d;
        }
        
        .sidebar-logo {
            font-size: 24px;
            font-weight: bold;
            color: #10a37f;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .user-info {
            font-size: 14px;
            color: #8b949e;
            margin-bottom: 12px;
        }
        
        .logout-btn {
            background: #21262d;
            border: 1px solid #30363d;
            color: #f0f6fc;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            width: 100%;
            cursor: pointer;
        }
        
        .new-chat-btn {
            margin: 16px;
            background: #238636;
            border: none;
            color: #fff;
            padding: 12px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 16px;
        }
        
        .chat-item {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-item.active {
            background: #1f6feb;
            border-color: #388bfd;
        }
        
        .chat-item-title {
            flex: 1;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .delete-chat-btn {
            background: none;
            border: none;
            color: #f85149;
            font-size: 18px;
            padding: 4px 8px;
            cursor: pointer;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding-top: 56px;
            height: 100vh;
            background: #0d1117;
        }
        
        /* Messages Container */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            -webkit-overflow-scrolling: touch;
        }
        
        .message {
            margin-bottom: 24px;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
        }
        
        .user-avatar {
            background: #1f6feb;
        }
        
        .assistant-avatar {
            background: #10a37f;
        }
        
        .message-role {
            font-size: 14px;
            font-weight: 600;
            color: #8b949e;
        }
        
        .message-content {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 16px;
            margin-left: 42px;
            font-size: 15px;
            line-height: 1.6;
            color: #f0f6fc;
        }
        
        .message-content h1, .message-content h2, .message-content h3 {
            margin: 16px 0 8px 0;
            color: #58a6ff;
        }
        
        .message-content p {
            margin-bottom: 12px;
        }
        
        .message-content ul, .message-content ol {
            margin-left: 20px;
            margin-bottom: 12px;
        }
        
        .message-content code {
            background: #30363d;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 0.9em;
        }
        
        .message-content pre {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px;
            overflow-x: auto;
            margin-bottom: 12px;
        }
        
        /* File Preview */
        .file-preview {
            background: #1c2128;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .file-icon {
            width: 40px;
            height: 40px;
            background: #30363d;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .file-size {
            font-size: 12px;
            color: #8b949e;
        }
        
        /* Chart Container */
        .chart-container {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            position: relative;
        }
        
        .chart-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }
        
        .chart-btn {
            background: rgba(16, 163, 127, 0.9);
            border: none;
            color: #fff;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Input Area */
        .input-area {
            background: #0d1117;
            border-top: 1px solid #30363d;
            padding: 12px 16px 20px;
        }
        
        .attached-files {
            margin-bottom: 12px;
        }
        
        .attached-file {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 8px 12px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-right: 8px;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .remove-file {
            background: none;
            border: none;
            color: #f85149;
            font-size: 16px;
            cursor: pointer;
            padding: 0 4px;
        }
        
        .input-wrapper {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 8px 12px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }
        
        .input-wrapper:focus-within {
            border-color: #1f6feb;
        }
        
        .file-btn {
            background: none;
            border: none;
            color: #8b949e;
            font-size: 22px;
            padding: 6px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .chat-input {
            flex: 1;
            background: none;
            border: none;
            color: #f0f6fc;
            font-size: 16px;
            line-height: 1.5;
            resize: none;
            outline: none;
            min-height: 24px;
            max-height: 120px;
            font-family: inherit;
        }
        
        .send-btn {
            background: #10a37f;
            border: none;
            color: #fff;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .send-btn:disabled {
            background: #30363d;
            color: #8b949e;
        }
        
        /* Loading Animation */
        .loading {
            display: flex;
            gap: 4px;
            padding: 20px;
            justify-content: center;
        }
        
        .loading-dot {
            width: 8px;
            height: 8px;
            background: #8b949e;
            border-radius: 50%;
            animation: pulse 1.4s ease-in-out infinite;
        }
        
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes pulse {
            0%, 60%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            30% {
                transform: scale(1.5);
                opacity: 0.5;
            }
        }
        
        /* Login Screen */
        .login-screen {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
        }
        
        .login-box {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 16px;
            padding: 32px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }
        
        .login-logo {
            text-align: center;
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .login-title {
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            color: #10a37f;
            margin-bottom: 8px;
        }
        
        .login-subtitle {
            text-align: center;
            font-size: 16px;
            color: #8b949e;
            margin-bottom: 32px;
        }
        
        .login-input {
            width: 100%;
            background: #161b22;
            border: 1px solid #30363d;
            color: #f0f6fc;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 16px;
            outline: none;
        }
        
        .login-input:focus {
            border-color: #1f6feb;
        }
        
        .login-btn {
            width: 100%;
            background: #10a37f;
            border: none;
            color: #fff;
            padding: 14px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
        }
        
        .login-error {
            background: #f851491a;
            border: 1px solid #f85149;
            color: #f85149;
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            text-align: center;
            font-size: 14px;
        }
        
        .login-info {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 16px;
            margin-top: 24px;
            text-align: center;
            font-size: 14px;
            color: #8b949e;
        }
        
        .login-info strong {
            color: #f0f6fc;
        }
        
        /* Presentation Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #f0f6fc;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #8b949e;
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
        }
        
        .modal-input {
            width: 100%;
            background: #161b22;
            border: 1px solid #30363d;
            color: #f0f6fc;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            outline: none;
        }
        
        .modal-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .modal-btn {
            background: #10a37f;
            border: none;
            color: #fff;
            padding: 14px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .modal-btn.secondary {
            background: #1f6feb;
        }
        
        /* Desktop Adjustments */
        @media (min-width: 768px) {
            .header-mobile {
                display: none;
            }
            
            .sidebar {
                position: relative;
                left: 0;
                width: 320px;
                box-shadow: none;
                border-right: 1px solid #30363d;
            }
            
            .sidebar-overlay {
                display: none;
            }
            
            .main-content {
                padding-top: 0;
            }
            
            .app {
                flex-direction: row;
            }
            
            .messages-container {
                padding: 24px;
            }
            
            .message-content {
                max-width: 800px;
            }
            
            .input-area {
                padding: 20px 24px;
            }
            
            .input-wrapper {
                max-width: 800px;
                margin: 0 auto;
            }
        }
        
        /* Utilities */
        .hidden {
            display: none !important;
        }
        
        /* Safe area for iOS */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .input-area {
                padding-bottom: calc(20px + env(safe-area-inset-bottom));
            }
        }
        
        /* Admin Panel Styles */
        .admin-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(13, 17, 23, 0.9);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
        }
        
        .admin-panel.open {
            opacity: 1;
            visibility: visible;
        }
        
        .admin-panel-content {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 16px;
            width: 95%;
            max-width: 1400px;
            max-height: 95vh;
            overflow: hidden;
            position: relative;
            animation: slideUp 0.3s ease;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .admin-panel-header {
            padding: 24px 32px;
            background: linear-gradient(135deg, #1e3a5f 0%, #0d1929 100%);
            border-bottom: 1px solid #30363d;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .admin-panel-title {
            font-size: 24px;
            font-weight: 600;
            color: #58a6ff;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .admin-panel-close {
            background: rgba(240, 246, 252, 0.1);
            border: none;
            color: #f0f6fc;
            font-size: 20px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .admin-panel-close:hover {
            background: rgba(240, 246, 252, 0.2);
            transform: scale(1.05);
        }
        
        .admin-panel-tabs {
            display: flex;
            padding: 0 32px;
            background: #161b22;
            border-bottom: 1px solid #30363d;
            gap: 8px;
        }
        
        .admin-tab {
            padding: 16px 24px;
            color: #8b949e;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            margin-bottom: -1px;
        }
        
        .admin-tab:hover {
            color: #f0f6fc;
            background: rgba(56, 139, 253, 0.1);
        }
        
        .admin-tab.active {
            color: #58a6ff;
            border-bottom: 2px solid #58a6ff;
            background: rgba(56, 139, 253, 0.1);
        }
        
        .admin-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #58a6ff;
            box-shadow: 0 0 8px rgba(88, 166, 255, 0.5);
        }
        
        .admin-panel-body {
            padding: 32px;
            overflow-y: auto;
            flex: 1;
            background: #0d1117;
        }
        
        .prompt-editor {
            display: flex;
            flex-direction: column;
            gap: 24px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .prompt-textarea {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 24px;
            color: #f0f6fc;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.6;
            height: 600px;
            resize: vertical;
            transition: all 0.2s;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .prompt-textarea:focus {
            border-color: #58a6ff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.3);
        }
        
        .prompt-actions {
            display: flex;
            gap: 16px;
            justify-content: flex-end;
            padding: 16px 0;
        }
        
        .prompt-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .prompt-save {
            background: #238636;
            color: white;
            border: none;
            box-shadow: 0 2px 4px rgba(35, 134, 54, 0.2);
        }
        
        .prompt-save:hover {
            background: #2ea043;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(35, 134, 54, 0.3);
        }
        
        .prompt-save:active {
            transform: translateY(0);
        }
        
        .prompt-save:disabled {
            background: #238636;
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .prompt-cancel {
            background: #21262d;
            color: #f0f6fc;
            border: 1px solid #30363d;
        }
        
        .prompt-cancel:hover {
            background: #30363d;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .prompt-cancel:active {
            transform: translateY(0);
        }
        
        .status {
            padding: 16px;
            border-radius: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .status.success {
            background: rgba(35, 134, 54, 0.1);
            border: 1px solid rgba(35, 134, 54, 0.2);
            color: #3fb950;
        }
        
        .status.error {
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid rgba(248, 81, 73, 0.2);
            color: #f85149;
        }
        
        /* Melhorias na lista de usu√°rios */
        .user-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }
        
        .user-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
        }
        
        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border-color: #58a6ff;
        }
        
        .user-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .user-card-name {
            font-size: 18px;
            font-weight: 600;
            color: #f0f6fc;
        }
        
        .user-card-delete {
            background: none;
            border: none;
            color: #f85149;
            cursor: pointer;
            font-size: 20px;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .user-card-delete:hover {
            background: rgba(248, 81, 73, 0.1);
            transform: scale(1.1);
        }
        
        .user-card-info {
            font-size: 14px;
            color: #8b949e;
            margin-top: 8px;
        }
        
        .user-form {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
        }
        
        .form-title {
            font-size: 18px;
            font-weight: 600;
            color: #f0f6fc;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .form-input {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px 16px;
            color: #f0f6fc;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .form-input:focus {
            border-color: #58a6ff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.3);
        }
        
        .form-submit {
            background: #238636;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        
        .form-submit:hover {
            background: #2ea043;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(35, 134, 54, 0.3);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        
        // API Configuration
        const API_BASE = 'http://localhost:8000/api';
        
        // API Functions
        const api = {
            login: async (username, password) => {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                return response.json();
            },
            
            getChats: async (username) => {
                const response = await fetch(`${API_BASE}/chats/${username}`);
                return response.json();
            },
            
            createChat: async (username, title = 'Nova Conversa') => {
                const response = await fetch(`${API_BASE}/chats/${username}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title })
                });
                return response.json();
            },
            
            deleteChat: async (username, chatId) => {
                const response = await fetch(`${API_BASE}/chats/${username}/${chatId}`, {
                    method: 'DELETE'
                });
                return response.json();
            },
            
            sendMessage: async (username, chatId, message, files = []) => {
                const response = await fetch(`${API_BASE}/message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, chatId, message, files })
                });
                return response.json();
            },
            
            updateChatTitle: async (username, chatId, title) => {
                const response = await fetch(`${API_BASE}/chats/${username}/${chatId}/update`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title })
                });
                return response.json();
            },
            
            generatePresentation: async (username, chatId, clientName) => {
                const response = await fetch(`${API_BASE}/generate-presentation`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, chatId, clientName })
                });
                return response.json();
            }
        };
        
        // Login Component
        const Login = ({ onLogin }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                
                try {
                    const result = await api.login(username, password);
                    if (result.success) {
                        onLogin(username, result.role === 'admin', result.name);
                    } else {
                        setError(result.message || 'Erro ao fazer login');
                    }
                } catch (err) {
                    setError('Erro de conex√£o');
                }
                
                setLoading(false);
            };
            
            return (
                <div className="login-screen">
                    <div className="login-box">
                        <div className="login-logo">üè¢</div>
                        <h1 className="login-title">Horizont IA</h1>
                        <p className="login-subtitle">Consultor Virtual Inteligente</p>
                        
                        <form onSubmit={handleSubmit}>
                            <input
                                type="text"
                                className="login-input"
                                placeholder="Usu√°rio"
                                value={username}
                                onChange={(e) => setUsername(e.target.value)}
                                required
                                autoComplete="username"
                            />
                            <input
                                type="password"
                                className="login-input"
                                placeholder="Senha"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                required
                                autoComplete="current-password"
                            />
                            <button type="submit" className="login-btn" disabled={loading}>
                                {loading ? 'Entrando...' : 'Entrar'}
                            </button>
                        </form>
                        
                        {error && <div className="login-error">{error}</div>}
                        
                        <div className="login-info">
                            <strong>Demo:</strong><br />
                            admin / horizont2025<br />
                            carlos / 123456
                        </div>
                    </div>
                </div>
            );
        };
        
        // Chart Component
        const Chart = ({ data, onSave }) => {
            const chartRef = useRef(null);
            const chartId = useRef(`chart-${Date.now()}`).current;
            
            // Fun√ß√£o para formatar valores monet√°rios
            const formatCurrency = (value) => {
                if (value >= 1000000) {
                    return `R$ ${(value / 1000000).toFixed(2)}M`;
                } else if (value >= 1000) {
                    return `R$ ${(value / 1000).toFixed(1)}k`;
                }
                return `R$ ${value.toFixed(2)}`;
            };
            
            useEffect(() => {
                if (!data || !chartRef.current) return;
                
                // Extrair dados customizados se existirem
                let traces = [];
                let layout = {};
                
                if (data.products) {
                    // Gr√°fico customizado com produtos espec√≠ficos
                    const years = Array.from({ length: (data.years || 5) + 1 }, (_, i) => i);
                    const initialValue = data.initialValue || 100000;
                    
                    Object.entries(data.products).forEach(([name, info]) => {
                        let yearlyMultiplier;
                        
                        // Usar yearlyMultiplier se dispon√≠vel, sen√£o calcular
                        if (info.yearlyMultiplier) {
                            yearlyMultiplier = info.yearlyMultiplier;
                        } else if (info.monthlyRate) {
                            yearlyMultiplier = Math.pow(1 + info.monthlyRate, 12);
                        } else if (info.rate) {
                            yearlyMultiplier = 1 + (info.rate / 100);
                        } else {
                            yearlyMultiplier = 1.1; // fallback
                        }
                        
                        traces.push({
                            x: years,
                            y: years.map(year => initialValue * Math.pow(yearlyMultiplier, year)),
                            name: name,
                            mode: 'lines+markers',
                            line: { width: 3 },
                            text: years.map(year => {
                                const value = initialValue * Math.pow(yearlyMultiplier, year);
                                return `R$ ${value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                            }),
                            hovertemplate: '%{text}<extra></extra>'
                        });
                    });
                    
                    layout = {
                        title: data.title || 'Comparativo de Investimentos',
                        xaxis: { 
                            title: 'Anos',
                            gridcolor: 'rgba(255,255,255,0.1)'
                        },
                        yaxis: { 
                            title: 'Valor',
                            tickformat: '~s',
                            tickmode: 'auto',
                            nticks: 8,
                            gridcolor: 'rgba(255,255,255,0.1)',
                            tickfont: { size: 11 }
                        }
                    };
                } else {
                    // Gr√°fico padr√£o
                    const years = Array.from({ length: (data.years || 5) + 1 }, (_, i) => i);
                    const initialValue = data.initialValue || 100000;
                    
                    traces = [
                        {
                            x: years,
                            y: years.map(year => initialValue * Math.pow(1.0775, year)),
                            name: 'Poupan√ßa (7.75%)',
                            line: { color: '#ff6b6b' }
                        },
                        {
                            x: years,
                            y: years.map(year => initialValue * Math.pow(1.1088, year)),
                            name: 'CDI (10.88%)',
                            line: { color: '#ffa726' }
                        },
                        {
                            x: years,
                            y: years.map(year => initialValue * Math.pow(1.1539, year)), // 1.20% ao m√™s = 15.39% ao ano
                            name: 'Horizont Smart (15.39%)',
                            line: { color: '#51cf66' }
                        },
                        {
                            x: years,
                            y: years.map(year => initialValue * Math.pow(1.1937, year)),
                            name: 'Horizont Trend (19.37%)',
                            line: { color: '#339af0' }
                        }
                    ];
                    
                    layout = {
                        title: 'üìä Comparativo de Investimentos',
                        xaxis: { 
                            title: 'Anos',
                            gridcolor: 'rgba(255,255,255,0.1)'
                        },
                        yaxis: { 
                            title: 'Valor (R$)',
                            tickformat: ',.0f',
                            gridcolor: 'rgba(255,255,255,0.1)'
                        }
                    };
                }
                
                // Layout comum
                layout = {
                    ...layout,
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: 'white', size: 12 },
                    showlegend: true,
                    legend: {
                        x: 0,
                        y: 1,
                        bgcolor: 'rgba(0,0,0,0.5)'
                    },
                    margin: { l: 100, r: 20, t: 60, b: 60 },
                    autosize: true,
                    yaxis: {
                        ...layout.yaxis,
                        tickformat: ',.0f',
                        tickprefix: 'R$ ',
                        separatethousands: true
                    }
                };
                
                // Configurar locale para portugu√™s
                const config = {
                    responsive: true,
                    displayModeBar: false,
                    locale: 'pt-br',
                    locales: {
                        'pt-br': {
                            format: {
                                thousands: '.',
                                decimal: ','
                            }
                        }
                    }
                };
                
                Plotly.newPlot(chartRef.current, traces, layout, config);
                
                // Resize handler
                const handleResize = () => {
                    Plotly.Plots.resize(chartRef.current);
                };
                
                window.addEventListener('resize', handleResize);
                
                return () => {
                    window.removeEventListener('resize', handleResize);
                    if (chartRef.current) {
                        Plotly.purge(chartRef.current);
                    }
                };
            }, [data]);
            
            const handleSave = async () => {
                try {
                    await Plotly.downloadImage(chartRef.current, {
                        format: 'png',
                        width: 1200,
                        height: 800,
                        filename: `horizont-comparativo-${Date.now()}`
                    });
                } catch (err) {
                    console.error('Erro ao salvar:', err);
                }
            };
            
            const handleShare = async () => {
                try {
                    const imgData = await Plotly.toImage(chartRef.current, {
                        format: 'png',
                        width: 1200,
                        height: 800
                    });
                    
                    const response = await fetch(imgData);
                    const blob = await response.blob();
                    const file = new File([blob], 'horizont-comparativo.png', { type: 'image/png' });
                    
                    if (navigator.share && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            title: 'Comparativo Horizont Investimentos',
                            text: 'Veja o comparativo de rentabilidade dos investimentos',
                            files: [file]
                        });
                    } else {
                        handleSave();
                    }
                } catch (err) {
                    handleSave();
                }
            };
            
            return (
                <div className="chart-container">
                    <div className="chart-actions">
                        <button className="chart-btn" onClick={handleSave}>
                            üíæ Salvar
                        </button>
                        <button className="chart-btn" onClick={handleShare}>
                            üì§ Enviar
                        </button>
                    </div>
                    <div ref={chartRef} id={chartId} style={{ width: '100%', height: '300px' }}></div>
                </div>
            );
        };
        
        // Presentation Modal
        const PresentationModal = ({ isOpen, onClose, chatData, username }) => {
            const [clientName, setClientName] = useState('');
            
            if (!isOpen) return null;
            
            const generatePDF = async () => {
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF();
                    
                    // Header
                    pdf.setFontSize(24);
                    pdf.setTextColor(16, 163, 127);
                    pdf.text('Horizont Investimentos', 105, 30, { align: 'center' });
                    
                    pdf.setFontSize(16);
                    pdf.setTextColor(0, 0, 0);
                    pdf.text('Proposta de Investimento', 105, 45, { align: 'center' });
                    
                    // Client info
                    pdf.setFontSize(12);
                    pdf.text(`Cliente: ${clientName || 'Cliente'}`, 20, 70);
                    pdf.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 80);
                    
                    // Extract calculations
                    let yPos = 100;
                    const messages = chatData?.messages || [];
                    
                    messages.forEach(msg => {
                        if (msg.role === 'assistant' && msg.content.includes('R$')) {
                            const lines = pdf.splitTextToSize(msg.content.substring(0, 500), 170);
                            lines.forEach(line => {
                                if (yPos > 270) {
                                    pdf.addPage();
                                    yPos = 20;
                                }
                                pdf.text(line, 20, yPos);
                                yPos += 7;
                            });
                        }
                    });
                    
                    pdf.save(`proposta-horizont-${clientName || 'cliente'}.pdf`);
                } catch (err) {
                    alert('Erro ao gerar PDF');
                }
            };
            
            const shareWhatsApp = () => {
                const messages = chatData?.messages || [];
                let summary = `üè¢ *Horizont Investimentos*\n\n`;
                summary += `üìä Proposta para ${clientName || 'Cliente'}\n\n`;
                
                // Extract key numbers
                for (const msg of messages) {
                    if (msg.role === 'assistant') {
                        const matches = msg.content.match(/R\$\s*[\d.,]+/g);
                        if (matches && matches.length > 0) {
                            summary += `üí∞ Valores encontrados:\n`;
                            matches.slice(0, 5).forEach(match => {
                                summary += `‚Ä¢ ${match}\n`;
                            });
                            break; // Now break works with for...of
                        }
                    }
                }
                
                summary += `\nüì± Gerado pelo Horizont IA`;
                
                const url = `https://wa.me/?text=${encodeURIComponent(summary)}`;
                window.open(url, '_blank');
            };
            
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">Gerar Proposta</h2>
                            <button className="modal-close" onClick={onClose}>‚úï</button>
                        </div>
                        
                        <input
                            type="text"
                            className="modal-input"
                            placeholder="Nome do cliente"
                            value={clientName}
                            onChange={(e) => setClientName(e.target.value)}
                        />
                        
                        <div className="modal-actions">
                            <button className="modal-btn" onClick={generatePDF}>
                                üìÑ Gerar PDF
                            </button>
                            <button className="modal-btn secondary" onClick={shareWhatsApp}>
                                üì± Enviar WhatsApp
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        
        // Admin Panel Component
        const AdminPanel = ({ isOpen, onClose }) => {
            const [activeTab, setActiveTab] = useState('users');
            const [users, setUsers] = useState([]);
            const [newUser, setNewUser] = useState({ username: '', password: '', name: '', cpf: '' });
            const [selectedUser, setSelectedUser] = useState(null);
            const [userChats, setUserChats] = useState([]);
            const [selectedChat, setSelectedChat] = useState(null);
            const [loading, setLoading] = useState(false);
            const [promptText, setPromptText] = useState('');
            const [status, setStatus] = useState({ type: '', message: '' });

            useEffect(() => {
                if (isOpen) {
                    if (activeTab === 'users') {
                        loadUsers();
                    } else if (activeTab === 'prompt') {
                        loadPrompt();
                    }
                }
            }, [isOpen, activeTab]);

            const loadUsers = async () => {
                try {
                    const response = await fetch(`/api/admin/users`);
                    const data = await response.json();
                    if (data.success) {
                        setUsers(data.users);
                    }
                } catch (err) {
                    console.error('Erro ao carregar usu√°rios:', err);
                }
            };

            const loadPrompt = async () => {
                try {
                    const response = await fetch('/api/admin/config/prompt');
                    const data = await response.json();
                    if (data.success) {
                        setPromptText(data.prompt);
                    } else {
                        throw new Error('Erro ao carregar');
                    }
                } catch (error) {
                    console.error('Erro ao carregar prompt:', error);
                    setStatus({
                        type: 'error',
                        message: 'Erro ao carregar o prompt'
                    });
                }
            };

            const handleSavePrompt = async () => {
                if (!promptText.trim()) {
                    setStatus({
                        type: 'error',
                        message: 'O prompt n√£o pode estar vazio'
                    });
                    return;
                }

                setLoading(true);
                try {
                    const response = await fetch('/api/admin/config/prompt', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ prompt: promptText })
                    });

                    if (response.ok) {
                        setStatus({
                            type: 'success',
                            message: '‚úÖ Prompt atualizado com sucesso!'
                        });
                        setTimeout(() => setStatus({ type: '', message: '' }), 3000);
                    } else {
                        throw new Error('Erro ao salvar');
                    }
                } catch (error) {
                    console.error('Erro ao salvar prompt:', error);
                    setStatus({
                        type: 'error',
                        message: '‚ùå Erro ao salvar o prompt'
                    });
                }
                setLoading(false);
            };

            const createUser = async (e) => {
                e.preventDefault();
                if (!newUser.username || !newUser.password || !newUser.name || !newUser.cpf) {
                    alert('Todos os campos s√£o obrigat√≥rios!');
                    return;
                }

                try {
                    const response = await fetch('/api/admin/users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newUser)
                    });
                    const data = await response.json();

                    if (data.success) {
                        alert('Representante criado com sucesso!');
                        setNewUser({ username: '', password: '', name: '', cpf: '' });
                        loadUsers();
                    } else {
                        alert(data.message);
                    }
                } catch (err) {
                    alert('Erro ao criar representante');
                }
            };

            const deleteUser = async (username) => {
                if (!confirm(`Deletar usu√°rio ${username}?`)) return;

                try {
                    const response = await fetch(`/api/admin/users/${username}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        loadUsers();
                        if (selectedUser === username) {
                            setSelectedUser(null);
                            setUserChats([]);
                        }
                    }
                } catch (err) {
                    alert('Erro ao deletar usu√°rio');
                }
            };

            const loadUserChats = async (username) => {
                setLoading(true);
                try {
                    const response = await fetch(`/api/admin/users/${username}/chats`);
                    const data = await response.json();
                    if (data.success) {
                        setUserChats(data.chats);
                        setSelectedUser(username);
                    }
                } catch (err) {
                    console.error('Erro ao carregar chats:', err);
                }
                setLoading(false);
            };

            const loadChatDetails = async (username, chatId) => {
                try {
                    const response = await fetch(`/api/admin/users/${username}/chats/${chatId}`);
                    const data = await response.json();
                    if (data.success) {
                        setSelectedChat(data.chat);
                    }
                } catch (err) {
                    console.error('Erro ao carregar detalhes:', err);
                }
            };

            return (
                <div className={`admin-panel ${isOpen ? 'open' : ''}`}>
                    <div className="admin-panel-content">
                        <div className="admin-panel-header">
                            <div className="admin-panel-title">üõ†Ô∏è Painel Administrativo</div>
                            <button className="admin-panel-close" onClick={onClose}>√ó</button>
                        </div>

                        <div className="admin-panel-tabs">
                            <div 
                                className={`admin-tab ${activeTab === 'users' ? 'active' : ''}`}
                                onClick={() => setActiveTab('users')}
                            >
                                üë• Usu√°rios
                            </div>
                            <div 
                                className={`admin-tab ${activeTab === 'prompt' ? 'active' : ''}`}
                                onClick={() => setActiveTab('prompt')}
                            >
                                ‚öôÔ∏è Configura√ß√£o do Prompt
                            </div>
                        </div>

                        <div className="admin-panel-body">
                            {activeTab === 'prompt' && (
                                <div className="prompt-editor">
                                    <textarea
                                        className="prompt-textarea"
                                        value={promptText}
                                        onChange={(e) => setPromptText(e.target.value)}
                                        placeholder="Digite o prompt do Claude aqui..."
                                    />
                                    {status.message && (
                                        <div className={`status ${status.type}`}>
                                            {status.message}
                                        </div>
                                    )}
                                    <div className="prompt-actions">
                                        <button 
                                            className="prompt-btn prompt-cancel"
                                            onClick={onClose}
                                        >
                                            ‚ùå Cancelar
                                        </button>
                                        <button 
                                            className="prompt-btn prompt-save"
                                            onClick={handleSavePrompt}
                                            disabled={loading}
                                        >
                                            {loading ? '‚è≥ Salvando...' : 'üíæ Salvar Altera√ß√µes'}
                                        </button>
                                    </div>
                                </div>
                            )}
                            {activeTab === 'users' && (
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
                                    {/* Criar Novo Usu√°rio */}
                                    <div className="user-form">
                                        <div className="form-title">
                                            ‚ûï Criar Novo Representante
                                        </div>
                                        <form onSubmit={createUser}>
                                            <div className="form-grid">
                                                <input
                                                    type="text"
                                                    className="form-input"
                                                    placeholder="Nome completo"
                                                    value={newUser.name}
                                                    onChange={(e) => setNewUser({ ...newUser, name: e.target.value })}
                                                />
                                                <input
                                                    type="text"
                                                    className="form-input"
                                                    placeholder="CPF"
                                                    value={newUser.cpf}
                                                    onChange={(e) => setNewUser({ ...newUser, cpf: e.target.value })}
                                                />
                                                <input
                                                    type="text"
                                                    className="form-input"
                                                    placeholder="Login"
                                                    value={newUser.username}
                                                    onChange={(e) => setNewUser({ ...newUser, username: e.target.value })}
                                                />
                                                <input
                                                    type="password"
                                                    className="form-input"
                                                    placeholder="Senha"
                                                    value={newUser.password}
                                                    onChange={(e) => setNewUser({ ...newUser, password: e.target.value })}
                                                />
                                            </div>
                                            <button type="submit" className="form-submit">
                                                ‚ûï Criar Representante
                                            </button>
                                        </form>
                                    </div>

                                    {/* Lista de Usu√°rios */}
                                    <div className="user-list">
                                        {users.map(user => (
                                            <div key={user.username} className="user-card">
                                                <div className="user-card-header">
                                                    <div className="user-card-name">
                                                        {user.name}
                                                    </div>
                                                    <button
                                                        onClick={() => deleteUser(user.username)}
                                                        className="user-card-delete"
                                                    >
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                                <div className="user-card-info">
                                                    Login: {user.username}
                                                </div>
                                                <div className="user-card-info">
                                                    CPF: {user.cpf}
                                                </div>
                                                <div className="user-card-info">
                                                    {user.chatsCount} conversas
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Modal de Detalhes do Chat */}
                    {selectedChat && (
                        <div className="modal-overlay" onClick={() => setSelectedChat(null)}>
                            <div className="modal-content" style={{ maxHeight: '80vh', overflowY: 'auto' }} onClick={e => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h2 className="modal-title">üìã Detalhes da Conversa</h2>
                                    <button className="modal-close" onClick={() => setSelectedChat(null)}>‚úï</button>
                                </div>

                                <div style={{ fontSize: '14px' }}>
                                    {selectedChat.messages.map((msg, idx) => (
                                        <div key={idx} style={{
                                            padding: '12px',
                                            marginBottom: '8px',
                                            background: msg.role === 'user' ? '#1f6feb' : '#161b22',
                                            borderRadius: '8px'
                                        }}>
                                            <div style={{ fontWeight: 500, marginBottom: '4px' }}>
                                                {msg.role === 'user' ? 'üë§ Cliente' : 'üéØ Consultor'}
                                            </div>
                                            <div style={{ whiteSpace: 'pre-wrap' }}>{msg.content}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        // Main App Component
        const App = () => {
            const [user, setUser] = useState(null);
            const [userName, setUserName] = useState('');
            const [isAdmin, setIsAdmin] = useState(false);
            const [chats, setChats] = useState([]);
            const [activeChat, setActiveChat] = useState(null);
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [message, setMessage] = useState('');
            const [attachedFiles, setAttachedFiles] = useState([]);
            const [loading, setLoading] = useState(false);
            const [showPresentation, setShowPresentation] = useState(false);
            const [showAdminPanel, setShowAdminPanel] = useState(false);
            
            const messagesEndRef = useRef(null);
            const fileInputRef = useRef(null);
            const inputRef = useRef(null);
            
            // Auto scroll to bottom
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [chats, activeChat]);
            
            // Load chats on login
            useEffect(() => {
                if (user) {
                    loadChats();
                }
            }, [user]);
            
            const loadChats = async () => {
                try {
                    const result = await api.getChats(user);
                    if (result.success) {
                        setChats(result.chats);
                        if (result.chats.length > 0 && activeChat === null) {
                            setActiveChat(0);
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar chats:', err);
                }
            };
            
            const handleLogin = (username, isAdminUser = false, userName = '') => {
                setUser(username);
                setUserName(userName);
                setIsAdmin(isAdminUser);
            };
            
            const handleLogout = () => {
                setUser(null);
                setChats([]);
                setActiveChat(null);
            };
            
            const handleNewChat = async () => {
                try {
                    const result = await api.createChat(user);
                    if (result.success) {
                        await loadChats();
                        setActiveChat(chats.length);
                        setSidebarOpen(false);
                    }
                } catch (err) {
                    console.error('Erro ao criar chat:', err);
                }
            };
            
            const handleDeleteChat = async (index, e) => {
                e.stopPropagation();
                if (!confirm('Deletar conversa?')) return;
                
                try {
                    const chatId = chats[index].id;
                    await api.deleteChat(user, chatId);
                    await loadChats();
                    
                    if (activeChat === index) {
                        setActiveChat(chats.length > 1 ? 0 : null);
                    }
                } catch (err) {
                    console.error('Erro ao deletar:', err);
                }
            };
            
            const handleSendMessage = async () => {
                if (!message.trim() && attachedFiles.length === 0) return;
                if (activeChat === null || loading) return;
                
                const currentMessage = message;
                const currentFiles = attachedFiles;
                const chatId = chats[activeChat].id;
                
                setMessage('');
                setAttachedFiles([]);
                setLoading(true);
                
                try {
                    // Convert files to base64
                    const filesData = await Promise.all(
                        currentFiles.map(file => {
                            return new Promise((resolve) => {
                                const reader = new FileReader();
                                reader.onloadend = () => {
                                    resolve({
                                        name: file.name,
                                        type: file.type,
                                        size: file.size,
                                        data: reader.result.split(',')[1]
                                    });
                                };
                                reader.readAsDataURL(file.data);
                            });
                        })
                    );
                    
                    await api.sendMessage(user, chatId, currentMessage, filesData);
                    await loadChats();
                } catch (err) {
                    console.error('Erro ao enviar:', err);
                    alert('Erro ao enviar mensagem');
                }
                
                setLoading(false);
            };
            
            const handleFileSelect = (e) => {
                const files = Array.from(e.target.files);
                const newFiles = files.map(file => ({
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    data: file
                }));
                setAttachedFiles([...attachedFiles, ...newFiles]);
                e.target.value = '';
            };
            
            const removeFile = (index) => {
                setAttachedFiles(attachedFiles.filter((_, i) => i !== index));
            };
            
            const formatFileSize = (bytes) => {
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            };
            
            const renderMessage = (content) => {
                const html = marked.parse(content);
                return <div dangerouslySetInnerHTML={{ __html: html }} />;
            };
            
            if (!user) {
                return <Login onLogin={handleLogin} />;
            }
            
            const currentChat = activeChat !== null ? chats[activeChat] : null;
            
            return (
                <div className="app">
                    {/* Mobile Header */}
                    <div className="header-mobile">
                        <button className="menu-btn" onClick={() => setSidebarOpen(true)}>
                            ‚ò∞
                        </button>
                        <div className="header-title">Horizont IA</div>
                        <button className="header-action" onClick={() => setShowPresentation(true)}>
                            üìä
                        </button>
                    </div>
                    
                    {/* Sidebar Overlay */}
                    <div 
                        className={`sidebar-overlay ${sidebarOpen ? 'active' : ''}`}
                        onClick={() => setSidebarOpen(false)}
                    />
                    
                    {/* Sidebar */}
                    <div className={`sidebar ${sidebarOpen ? 'open' : ''}`}>
                        <div className="sidebar-header">
                            <div className="sidebar-logo">
                                üè¢ Horizont IA
                            </div>
                            <div className="user-info">
                                üë§ {userName || user}
                                {isAdmin && <span style={{ color: '#10a37f' }}> (Admin)</span>}
                            </div>
                            {isAdmin && (
                                <button 
                                    className="logout-btn" 
                                    onClick={() => setShowAdminPanel(true)}
                                    style={{ marginBottom: '10px', background: '#1f6feb' }}
                                >
                                    üõ†Ô∏è Painel Admin
                                </button>
                            )}
                            <button className="logout-btn" onClick={handleLogout}>
                                üö™ Sair
                            </button>
                        </div>
                        
                        <button className="new-chat-btn" onClick={handleNewChat}>
                            ‚ûï Nova Conversa
                        </button>
                        
                        <div className="chat-list">
                            {chats.map((chat, index) => (
                                <div
                                    key={chat.id}
                                    className={`chat-item ${activeChat === index ? 'active' : ''}`}
                                    onClick={() => {
                                        setActiveChat(index);
                                        setSidebarOpen(false);
                                    }}
                                >
                                    <span className="chat-item-title">{chat.title}</span>
                                    <button 
                                        className="delete-chat-btn"
                                        onClick={(e) => handleDeleteChat(index, e)}
                                    >
                                        üóëÔ∏è
                                    </button>
                                </div>
                            ))}
                        </div>
                    </div>
                    
                    {/* Main Content */}
                    <div className="main-content">
                        {currentChat ? (
                            <>
                                {/* Messages */}
                                <div className="messages-container">
                                    {currentChat.messages.map((msg, index) => (
                                        <div key={index} className="message">
                                            <div className="message-header">
                                                <div className={msg.role === 'user' ? 'user-avatar' : 'assistant-avatar'}>
                                                    {msg.role === 'user' ? 'üë§' : 'üéØ'}
                                                </div>
                                                <span className="message-role">
                                                    {msg.role === 'user' ? 'Voc√™' : 'Consultor Horizont'}
                                                </span>
                                            </div>
                                            <div className="message-content">
                                                {msg.files && msg.files.length > 0 && (
                                                    <div>
                                                        {msg.files.map((file, i) => (
                                                            <div key={i} className="file-preview">
                                                                <div className="file-icon">
                                                                    {file.type?.includes('pdf') ? 'üìÑ' : 'üìé'}
                                                                </div>
                                                                <div className="file-info">
                                                                    <div className="file-name">{file.name}</div>
                                                                    <div className="file-size">{formatFileSize(file.size)}</div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                                {renderMessage(msg.content)}
                                                {msg.chart && <Chart data={msg.chart} />}
                                            </div>
                                        </div>
                                    ))}
                                    
                                    {loading && (
                                        <div className="loading">
                                            <div className="loading-dot"></div>
                                            <div className="loading-dot"></div>
                                            <div className="loading-dot"></div>
                                        </div>
                                    )}
                                    
                                    <div ref={messagesEndRef} />
                                </div>
                                
                                {/* Input Area */}
                                <div className="input-area">
                                    {attachedFiles.length > 0 && (
                                        <div className="attached-files">
                                            {attachedFiles.map((file, index) => (
                                                <div key={index} className="attached-file">
                                                    <span>{file.type?.includes('pdf') ? 'üìÑ' : 'üìé'}</span>
                                                    <span>{file.name}</span>
                                                    <button className="remove-file" onClick={() => removeFile(index)}>
                                                        ‚úï
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    
                                    <div className="input-wrapper">
                                        <input
                                            type="file"
                                            ref={fileInputRef}
                                            className="hidden"
                                            multiple
                                            accept=".pdf,.jpg,.jpeg,.png,.xlsx,.xls,.csv"
                                            onChange={handleFileSelect}
                                        />
                                        <button className="file-btn" onClick={() => fileInputRef.current?.click()}>
                                            üìé
                                        </button>
                                        
                                        <textarea
                                            ref={inputRef}
                                            className="chat-input"
                                            placeholder="Digite sua mensagem..."
                                            value={message}
                                            onChange={(e) => {
                                                setMessage(e.target.value);
                                                e.target.style.height = 'auto';
                                                e.target.style.height = e.target.scrollHeight + 'px';
                                            }}
                                            onKeyPress={(e) => {
                                                if (e.key === 'Enter' && !e.shiftKey) {
                                                    e.preventDefault();
                                                    handleSendMessage();
                                                }
                                            }}
                                            rows={1}
                                            disabled={loading}
                                        />
                                        
                                        <button 
                                            className="send-btn"
                                            onClick={handleSendMessage}
                                            disabled={!message.trim() && attachedFiles.length === 0 || loading}
                                        >
                                            {loading ? '‚è≥' : 'üì§'}
                                        </button>
                                    </div>
                                </div>
                            </>
                        ) : (
                            <div className="messages-container">
                                <div style={{ 
                                    display: 'flex', 
                                    flexDirection: 'column', 
                                    alignItems: 'center', 
                                    justifyContent: 'center', 
                                    height: '100%',
                                    padding: '20px',
                                    textAlign: 'center'
                                }}>
                                    <div style={{ fontSize: '48px', marginBottom: '20px' }}>üè¢</div>
                                    <h2 style={{ fontSize: '24px', marginBottom: '10px', color: '#f0f6fc' }}>
                                        Bem-vindo ao Horizont IA
                                    </h2>
                                    <p style={{ color: '#8b949e', marginBottom: '30px' }}>
                                        Seu consultor inteligente para vendas
                                    </p>
                                    <button 
                                        className="new-chat-btn" 
                                        onClick={handleNewChat}
                                        style={{ maxWidth: '200px' }}
                                    >
                                        ‚ûï Iniciar Conversa
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {/* Presentation Modal */}
                    <PresentationModal
                        isOpen={showPresentation}
                        onClose={() => setShowPresentation(false)}
                        chatData={currentChat}
                        username={user}
                    />
                    
                    {/* Admin Panel */}
                    {isAdmin && (
                        <AdminPanel
                            isOpen={showAdminPanel}
                            onClose={() => setShowAdminPanel(false)}
                        />
                    )}
                </div>
            );
        };
        
        // Render App
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>