<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horizont IA</title>
    
    <!-- React e Babel -->
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>
    
    <script>
        // Configuração do Babel para suportar recursos modernos
        Babel.registerPreset("custom", {
            presets: [
                [Babel.availablePresets["env"]],
                [Babel.availablePresets["react"]]
            ],
            plugins: [
                [Babel.availablePlugins["proposal-optional-chaining"]],
                [Babel.availablePlugins["proposal-nullish-coalescing-operator"]],
                [Babel.availablePlugins["proposal-class-properties"]],
                [Babel.availablePlugins["proposal-object-rest-spread"]]
            ]
        });
    </script>
    
    <!-- Outras dependências -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --background-color: #1a1a1a;
            --surface-color: #2a2a2a;
            --surface-hover: #333333;
            --text-color: #ffffff;
            --text-secondary: #b3b3b3;
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --border-color: #404040;
            --danger-color: #dc2626;
            --success-color: #059669;
            --border-radius: 6px;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
        }

        /* Reset básico */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.5;
            height: 100vh;
            overflow: hidden;
        }

        #root {
            height: 100vh;
        }

        /* Layout principal */
        .app {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Login */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background-color: #1a1a1a;
        }

        .login-box {
            background-color: #2a2a2a;
            padding: 30px;
            border-radius: 6px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .login-title {
            color: #ffffff;
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .login-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #404040;
            border-radius: 6px;
            background: #1a1a1a;
            color: #ffffff;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .login-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background-color: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }

        .login-btn:hover {
            background-color: #1d4ed8;
        }

        .login-error {
            color: #dc2626;
            text-align: center;
            margin-top: 15px;
        }

        /* Menu mobile */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 900;
            background: #2a2a2a;
            border: none;
            color: #ffffff;
            font-size: 24px;
            padding: 10px 14px;
            border-radius: 6px;
            cursor: pointer;
            box-shadow: var(--shadow);
        }

        .menu-toggle.visible {
            display: block;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background-color: #2a2a2a;
            border-right: 1px solid #404040;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: #1a1a1a;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .menu-toggle.visible {
                display: block;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: -100%;
                width: 85%;
                height: 100%;
                background: var(--background-color);
                z-index: 1000;
                transition: left 0.3s ease;
            }

            .sidebar.open {
                left: 0;
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 800;
            }

            .sidebar-overlay.show {
                display: block;
            }

            .main-content {
                padding-top: 60px;
                width: 100%;
            }

            .input-container {
                padding: 8px;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: var(--surface-color);
                border-top: 1px solid var(--border-color);
                z-index: 100;
            }

            .input-wrapper {
                gap: 8px;
            }

            .message-input {
                padding: 10px;
                min-height: 40px;
                font-size: 15px;
            }

            .button {
                padding: 8px;
                height: 40px;
                min-width: 40px;
            }

            .messages {
                padding: 12px;
                padding-bottom: 80px; /* Espaço para o input fixo */
                gap: 12px;
            }

            .message {
                padding: 12px;
            }

            /* Ajustes para o chat container no mobile */
            .chat-container {
                display: flex;
                flex-direction: column;
                height: 100vh;
                width: 100%;
            }
        }

        /* Input container ajustado */
        .input-container {
            padding: 16px;
            background: var(--surface-color);
            border-top: 1px solid var(--border-color);
            position: sticky;
            bottom: 0;
            z-index: 10;
            margin: 0;
            width: 100%;
        }

        .input-wrapper {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            background: var(--background-color);
            border-radius: var(--border-radius);
            padding: 4px;
        }

        .message-input {
            flex: 1;
            min-height: 44px;
            max-height: 120px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--background-color);
            color: var(--text-color);
            font-size: 15px;
            resize: none;
            font-family: inherit;
            line-height: 1.5;
            margin: 0;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 0;
        }

        /* Ajustes nos botões */
        .button {
            padding: 8px 12px;
            height: 44px;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius);
            background: var(--primary-color);
            color: var(--text-color);
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
            margin: 0;
        }

        .attach-button {
            background-color: var(--surface-color);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .attach-button:hover:not(:disabled) {
            background: var(--surface-hover);
        }

        .clear-context-btn {
            background-color: var(--warning-color);
            color: white;
            border: 1px solid var(--warning-color);
        }

        .clear-context-btn:hover {
            background-color: #d97706;
        }

        .send-button {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: var(--text-color);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.2s ease;
        }

        .send-button:hover:not(:disabled) {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Ajuste no container principal */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
            background: var(--background-color);
        }

        /* Mensagens */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 6px;
            background: #2a2a2a;
            border: 1px solid #404040;
        }

        .message.user {
            background: #2563eb;
            border: none;
        }

        .message-input {
            flex: 1;
            min-height: 44px;
            max-height: 200px;
            padding: 12px;
            border: 1px solid #404040;
            border-radius: 6px;
            background: #1a1a1a;
            color: #ffffff;
            font-size: 16px;
            resize: vertical;
            font-family: inherit;
            transition: all 0.2s ease;
            line-height: 1.5;
        }

        .message-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }

        .message-input:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .input-container {
            padding: 20px;
            background: #2a2a2a;
            border-top: 1px solid #404040;
            position: sticky;
            bottom: 0;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-actions {
            display: flex;
            gap: 8px;
        }

        .button {
            padding: 8px 16px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .button:hover:not(:disabled) {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .attach-button {
            padding: 8px 12px;
            background: #404040;
        }

        .attach-button:hover:not(:disabled) {
            background: #4a4a4a;
        }

        .selected-files {
            margin-top: 10px;
            padding: 10px;
            background: #1a1a1a;
            border-radius: 6px;
        }

        .files-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            background: #2a2a2a;
            border-radius: 4px;
            font-size: 14px;
        }

        .remove-file {
            background: none;
            border: none;
            color: #dc2626;
            cursor: pointer;
            padding: 0 4px;
            font-size: 18px;
            line-height: 1;
        }

        .remove-file:hover {
            color: #ef4444;
        }

        /* Cores e variáveis básicas - sem CSS moderno */
        .app {
            --bg-color: #1a1a1a;
            --surface: #2a2a2a;
            --surface-hover: #333333;
            --text: #ffffff;
            --text-secondary: #b3b3b3;
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --border: #404040;
            --danger: #dc2626;
            --success: #059669;
            --radius: 6px;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Login styles */
        .login-title {
            color: var(--text-color);
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .login-error {
            color: var(--danger-color);
            text-align: center;
            margin-top: 15px;
        }

        /* Menu toggle button */
        .menu-toggle:hover {
            background: var(--surface-hover);
        }

        .menu-toggle.visible {
            display: block;
        }

        /* Sidebar Styles */
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--surface-color);
        }

        .sidebar-logo {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-color);
            letter-spacing: 0.5px;
        }

        .user-info {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
            padding: 12px;
            background-color: var(--background-color);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .user-actions {
            display: flex;
            gap: 8px;
            margin-top: 5px;
        }

        .admin-btn, .logout-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            width: 100%;
            transition: all 0.2s ease;
        }

        .admin-btn {
            background-color: var(--primary-color);
            color: var(--text-color);
        }

        .admin-btn:hover {
            background-color: var(--primary-hover);
        }

        .logout-btn {
            background-color: var(--danger-color);
            color: var(--text-color);
        }

        .logout-btn:hover {
            background-color: #d73a31;
        }

        .new-chat-btn {
            margin: 15px;
            padding: 12px;
            background-color: var(--primary-color);
            color: var(--text-color);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .new-chat-btn:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .new-chat-btn:active {
            transform: translateY(0);
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .chat-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-color);
            border: 1px solid transparent;
        }

        .chat-item:hover {
            background-color: var(--surface-hover);
            border-color: var(--border-color);
        }

        .chat-item.active {
            background-color: var(--surface-hover);
            border-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .chat-item-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: var(--spacing-sm);
        }

        .delete-chat-btn {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            padding: var(--spacing-xs);
            opacity: 0.7;
            transition: all 0.2s ease;
            border-radius: var(--border-radius);
        }

        .delete-chat-btn:hover {
            opacity: 1;
            background-color: rgba(248, 81, 73, 0.1);
        }

        /* Main Content Styles */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .user-avatar, .assistant-avatar {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: var(--text-color);
            font-weight: 500;
            box-shadow: var(--shadow);
        }

        .assistant-avatar {
            background-color: var(--secondary-color);
        }

        .message-role {
            font-weight: 500;
            color: var(--text-color);
        }

        .message-content {
            font-size: 0.95rem;
            line-height: 1.6;
            white-space: pre-wrap;
            color: var(--text-color);
            padding: 4px 0;
        }

        .message-content code {
            background-color: var(--background-color);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }

        .message-content pre {
            background-color: var(--background-color);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 8px 0;
            border: 1px solid var(--border-color);
        }

        /* Input Area Styles */
        .input-area {
            padding: 20px;
            background-color: var(--surface-color);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            background-color: var(--background-color);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid var(--border-color);
        }

        .input-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .attach-btn {
            padding: 8px;
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s ease;
            border-radius: 4px;
        }

        .attach-btn:hover {
            opacity: 1;
            background-color: var(--surface-hover);
        }

        .send-btn {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: var(--text-color);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.2s ease;
        }

        .send-btn:hover:not(:disabled) {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .attached-files {
            margin-bottom: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .file-preview {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .file-icon {
            font-size: 1.2rem;
        }

        .file-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .file-name {
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .file-size {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .remove-file-btn {
            padding: 4px;
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s ease;
            border-radius: 4px;
        }

        .remove-file-btn:hover {
            opacity: 1;
            background-color: rgba(220, 38, 38, 0.1);
        }

        /* Loading Indicator */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Scrollbar Styles */
        .chat-list::-webkit-scrollbar,
        .messages-container::-webkit-scrollbar {
            width: 8px;
        }

        .chat-list::-webkit-scrollbar-track,
        .messages-container::-webkit-scrollbar-track {
            background: var(--surface-color);
        }

        .chat-list::-webkit-scrollbar-thumb,
        .messages-container::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .chat-list::-webkit-scrollbar-thumb:hover,
        .messages-container::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Empty State */
        .empty-state {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: var(--text-secondary);
            text-align: center;
            font-size: 1.1rem;
        }

        .empty-state-content {
            text-align: center;
            padding: 40px;
        }
        
        /* Error Toast */
        .error-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(220, 38, 38, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 9999;
            font-size: 14px;
            max-width: 80%;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translate(-50%, -100%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        /* Login Screen */
        .login-screen {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background-color: var(--background-color);
        }

        .login-box {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
        }

        .login-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            color: var(--text-color);
        }

        .login-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--background-color);
            color: var(--text-color);
            font-size: 1rem;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: var(--text-color);
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .login-btn:hover {
            background-color: #1a5cc6;
        }

        /* Markdown Styles */
        .message-content p {
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .message-content ul, .message-content ol {
            margin-left: 20px;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
            color: var(--text-color);
        }

        .message-content th, .message-content td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: left;
        }

        .message-content th {
            background-color: var(--background-color);
        }

        .message-content blockquote {
            border-left: 4px solid var(--primary-color);
            padding-left: 15px;
            margin: 10px 0;
            color: var(--text-secondary);
        }

        /* Admin Panel Styles */
        .admin-panel {
            padding: 20px;
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            margin: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            position: relative;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .admin-header h1 {
            font-size: 1.5rem;
            color: var(--text-color);
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
        }

        .close-btn:hover {
            color: var(--danger-color);
        }

        .prompt-textarea {
            width: 100%;
            min-height: 200px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: monospace;
            resize: vertical;
            margin-bottom: 10px;
        }

        .save-prompt-btn {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: var(--text-color);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        .save-prompt-btn:hover {
            background-color: var(--primary-hover);
        }

        .save-prompt-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .user-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .user-input {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--background-color);
            color: var(--text-color);
            font-size: 1rem;
        }

        .create-user-btn {
            padding: 10px;
            background-color: var(--primary-color);
            color: var(--text-color);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        .create-user-btn:hover {
            background-color: var(--primary-hover);
        }

        .error-message {
            padding: 10px;
            background-color: var(--danger-color);
            color: var(--text-color);
            border-radius: var(--border-radius);
            margin-top: 10px;
        }

        .success-message {
            padding: 10px;
            background-color: var(--success-color);
            color: var(--text-color);
            border-radius: var(--border-radius);
            margin-top: 10px;
        }

        .admin-section {
            background-color: var(--background-color);
            padding: 20px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .admin-section h2 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .user-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .user-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
        }

        .user-item-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .user-item-name {
            font-weight: 500;
            color: var(--text-color);
        }

        .user-item-role {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .view-chats-btn {
            padding: 8px 12px;
            background-color: var(--primary-color);
            color: var(--text-color);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-chats-btn:hover {
            background-color: var(--primary-hover);
        }

        .admin-chat-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .admin-chat-list .chat-item {
            cursor: pointer;
            padding: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 8px;
            border-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--surface-color);
        }

        .admin-chat-list .chat-item:hover {
            background-color: var(--surface-hover);
        }

        .admin-chat-list .chat-item.active {
            border-color: var(--primary-color);
            background-color: var(--surface-hover);
        }

        .admin-messages {
            max-height: 500px;
            overflow-y: auto;
            padding: 20px;
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .message-date {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-left: auto;
        }

        .user-actions-btns {
            display: flex;
            gap: 8px;
        }

        .delete-user-btn {
            padding: 8px 12px;
            background-color: var(--danger-color);
            color: var(--text-color);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .delete-user-btn:hover {
            background-color: #b91c1c;
        }

        @media (max-width: 768px) {
            .user-actions-btns {
                flex-direction: column;
            }
        }

        .message.system {
            align-self: center;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            max-width: 70%;
            opacity: 0.8;
        }

        .message.system.error {
            background-color: rgba(220, 38, 38, 0.1);
            border-color: var(--danger-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .message.system.error:hover {
            background-color: rgba(220, 38, 38, 0.2);
            opacity: 1;
        }

        .message.system .message-header {
            color: var(--text-secondary);
        }

        .message.system.error .message-header {
            color: var(--danger-color);
        }

        .system-avatar {
            background-color: var(--text-secondary);
            opacity: 0.7;
        }

        .error-avatar {
            background-color: var(--danger-color);
            opacity: 0.7;
        }

        .chart-container {
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin: 20px 0;
            border: 1px solid var(--border-color);
        }
        
        .chart-wrapper {
            margin: 20px 0;
        }
        
        .chart-container canvas {
            max-width: 100%;
        }
    
        @media (max-width: 768px) {
            .chart-container {
                padding: 10px;
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-preset="custom">
        const useState = React.useState;
        const useEffect = React.useEffect;
        const useRef = React.useRef;
        
        // API Configuration
        const API_BASE = window.location.origin + '/api';
        
        // Utility Functions
        const renderMessage = (content) => {
            // Procurar por dados do gráfico
            const chartMatch = content.match(/\[GRAFICO_DADOS\]([\s\S]*?)\[\/GRAFICO_DADOS\]/);
            
            if (chartMatch) {
                try {
                    const chartData = JSON.parse(chartMatch[1]);
                    const textContent = content.replace(/\[GRAFICO_DADOS\][\s\S]*?\[\/GRAFICO_DADOS\]/, '');
                    const textHtml = marked.parse(textContent);
                    
                    return React.createElement('div', { key: `message-${Date.now()}-${Math.random()}` }, [
                        React.createElement('div', { 
                            key: 'text',
                            dangerouslySetInnerHTML: { __html: textHtml }
                        }),
                        React.createElement('div', { 
                            key: 'chart',
                            className: 'chart-container'
                        }, React.createElement(ChartComponent, { data: chartData }))
                    ]);
                } catch (e) {
                    console.error('Erro ao processar dados do gráfico:', e);
                }
            }
            
            const html = marked.parse(content);
            return React.createElement('div', { 
                key: `content-${Date.now()}-${Math.random()}`,
                dangerouslySetInnerHTML: { __html: html } 
            });
        };

        // Função auxiliar para gerar cores aleatórias
        const getRandomColor = () => {
            const colors = [
                '#2563eb', // Azul
                '#059669', // Verde
                '#dc2626', // Vermelho
                '#d97706', // Laranja
                '#7c3aed', // Roxo
                '#db2777', // Rosa
                '#2dd4bf', // Turquesa
                '#f59e0b'  // Amarelo
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        };

        // Chart Component
        const ChartComponent = React.memo(function ChartComponent(props) {
            const data = props.data;
            const canvasRef = React.useRef(null);
            const chartInstanceRef = React.useRef(null);
            const dataHashRef = React.useRef(null);
            const [chartError, setChartError] = React.useState(null);

            // Criar hash dos dados para evitar re-renders desnecessários
            const currentDataHash = React.useMemo(() => {
                try {
                    return JSON.stringify({
                        years: data.years,
                        initialValue: data.initialValue,
                        title: data.title,
                        products: Object.keys(data.products).sort()
                    });
                } catch (e) {
                    console.error('Erro ao criar hash dos dados:', e);
                    return null;
                }
            }, [data.years, data.initialValue, data.title, data.products]);

            React.useEffect(() => {
                // Limpar erro anterior
                setChartError(null);
                
                // Verificar se Chart.js está disponível
                if (typeof Chart === 'undefined') {
                    setChartError('Chart.js não está carregado');
                    return;
                }

                // Só recriar o gráfico se os dados realmente mudaram
                if (dataHashRef.current === currentDataHash) {
                    return;
                }
                
                dataHashRef.current = currentDataHash;
                
                const canvas = canvasRef.current;
                if (!canvas) {
                    setChartError('Canvas não encontrado');
                    return;
                }

                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    setChartError('Contexto 2D não disponível');
                    return;
                }

                try {
                    // Destruir gráfico anterior se existir
                    if (chartInstanceRef.current) {
                        chartInstanceRef.current.destroy();
                        chartInstanceRef.current = null;
                    }

                    // Verificar se os dados são válidos
                    if (!data || !data.products || !data.years || !data.initialValue) {
                        setChartError('Dados do gráfico inválidos');
                        return;
                    }

                    // Preparar dados para o gráfico
                    const labels = Array.from({ length: data.years * 12 + 1 }, (_, i) => i);
                    const datasets = Object.entries(data.products).map(([name, product]) => {
                        const monthlyMultiplier = Math.pow(1 + (product.rate / 100), 1/12);
                        const values = labels.map(month => {
                            return data.initialValue * Math.pow(monthlyMultiplier, month);
                        });

                        return {
                            label: name,
                            data: values,
                            borderColor: getRandomColor(),
                            backgroundColor: 'transparent',
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 4
                        };
                    });

                    // Criar novo gráfico
                    const newChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 800,
                                easing: 'easeInOutQuart'
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: data.title || 'Gráfico de Investimentos',
                                    color: '#ffffff',
                                    font: {
                                        size: 16,
                                        weight: 'bold'
                                    },
                                    padding: {
                                        top: 10,
                                        bottom: 20
                                    }
                                },
                                legend: {
                                    display: true,
                                    position: 'bottom',
                                    labels: {
                                        color: '#ffffff',
                                        padding: 20,
                                        font: {
                                            size: 12
                                        },
                                        usePointStyle: true,
                                        pointStyle: 'circle'
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleColor: '#ffffff',
                                    bodyColor: '#ffffff',
                                    borderColor: '#404040',
                                    borderWidth: 1,
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            label += new Intl.NumberFormat('pt-BR', {
                                                style: 'currency',
                                                currency: 'BRL'
                                            }).format(context.parsed.y);
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Meses',
                                        color: '#ffffff',
                                        font: {
                                            size: 12,
                                            weight: 'bold'
                                        }
                                    },
                                    ticks: {
                                        color: '#ffffff',
                                        maxTicksLimit: 20
                                    },
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)',
                                        drawBorder: false
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Valor (R$)',
                                        color: '#ffffff',
                                        font: {
                                            size: 12,
                                            weight: 'bold'
                                        }
                                    },
                                    ticks: {
                                        color: '#ffffff',
                                        callback: function(value) {
                                            return new Intl.NumberFormat('pt-BR', {
                                                style: 'currency',
                                                currency: 'BRL',
                                                notation: 'compact',
                                                compactDisplay: 'short'
                                            }).format(value);
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)',
                                        drawBorder: false
                                    }
                                }
                            },
                            interaction: {
                                mode: 'nearest',
                                axis: 'x',
                                intersect: false
                            }
                        }
                    });

                    chartInstanceRef.current = newChart;

                } catch (error) {
                    console.error('Erro ao criar gráfico:', error);
                    setChartError('Erro ao renderizar gráfico: ' + error.message);
                }

                return () => {
                    if (chartInstanceRef.current) {
                        try {
                            chartInstanceRef.current.destroy();
                        } catch (e) {
                            console.error('Erro ao destruir gráfico:', e);
                        }
                        chartInstanceRef.current = null;
                    }
                };
            }, [currentDataHash]); // Só depende do hash dos dados

            // Se há erro, mostrar mensagem
            if (chartError) {
                return React.createElement('div', {
                    className: 'chart-container',
                    style: {
                        padding: '20px',
                        textAlign: 'center',
                        color: '#dc2626',
                        backgroundColor: 'rgba(220, 38, 38, 0.1)',
                        border: '1px solid #dc2626',
                        borderRadius: '6px'
                    }
                }, `Erro no gráfico: ${chartError}`);
            }

            return React.createElement('div', {
                className: 'chart-wrapper',
                style: {
                    width: '100%',
                    height: '400px',
                    position: 'relative',
                    backgroundColor: 'var(--surface-color)',
                    borderRadius: 'var(--border-radius)',
                    padding: '20px',
                    margin: '20px 0',
                    border: '1px solid var(--border-color)'
                }
            }, React.createElement('canvas', {
                ref: canvasRef,
                style: {
                    width: '100%',
                    height: '100%'
                }
            }));
        });

        // API Functions
        const api = {
            login: async (username, password) => {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                return response.json();
            },
            
            getChats: async (username) => {
                const response = await fetch(API_BASE + '/chats/' + username);
                const data = await response.json();
                if (!data.success) throw new Error(data.message);
                return data.chats;
            },
            
            createChat: async (username, title = 'Nova Conversa') => {
                const response = await fetch(API_BASE + '/chats/' + username, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title })
                });
                const data = await response.json();
                if (!data.success) throw new Error(data.message);
                return { id: data.id, title: data.title };
            },
            
            deleteChat: async (username, chatId) => {
                const response = await fetch(API_BASE + '/chats/' + username + '/' + chatId, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (!data.success) throw new Error(data.message);
                return true;
            },
            
            sendMessage: async (username, chatId, message, files = []) => {
                try {
                    const response = await fetch(`${API_BASE}/message`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, chatId, message, files })
                    });

                    if (!response.ok) {
                        let errorMessage = 'Erro no servidor';
                        try {
                            const errorText = await response.text();
                            if (errorText) {
                                try {
                                    const errorJson = JSON.parse(errorText);
                                    errorMessage = errorJson.message || errorMessage;
                                } catch (e) {
                                    // If can't parse as JSON, use the raw text if it looks like text
                                    if (errorText.length < 200 && !errorText.includes('<')) {
                                        errorMessage = errorText;
                                    }
                                }
                            }
                        } catch (e) {
                            console.error('Erro ao ler resposta de erro:', e);
                        }
                        
                        if (response.status === 502) {
                            errorMessage = 'O servidor está temporariamente indisponível. Por favor, tente novamente em alguns instantes.';
                        } else if (response.status === 504) {
                            errorMessage = 'A requisição demorou muito para responder. Por favor, tente novamente.';
                        } else if (response.status === 413) {
                            errorMessage = 'A mensagem é muito grande. Por favor, tente uma mensagem menor.';
                        } else if (response.status === 429) {
                            errorMessage = 'Muitas requisições. Por favor, aguarde um momento antes de tentar novamente.';
                        }
                        
                        throw new Error(`${errorMessage} (Status: ${response.status})`);
                    }

                    const data = await response.json();
                    if (!data.success) throw new Error(data.message);
                    return data;
                } catch (err) {
                    console.error('Erro ao enviar mensagem:', err);
                    throw err;
                }
            },
            
            getUsers: async () => {
                const response = await fetch(`${API_BASE}/admin/users`);
                const data = await response.json();
                if (!data.success) throw new Error(data.message);
                return data.users;
            },
            
            createUser: async (userData) => {
                const response = await fetch(`${API_BASE}/admin/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
                const data = await response.json();
                if (!data.success) throw new Error(data.message);
                return true;
            },
            
            deleteUser: async (username) => {
                const response = await fetch(API_BASE + '/admin/users/' + username, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (!data.success) throw new Error(data.message);
                return true;
            },
            
            getPrompt: async () => {
                // Usar endpoint público para usuários normais, admin para admins
                const endpoint = isAdmin ? '/admin/config/prompt' : '/config/prompt';
                const response = await fetch(`${API_BASE}${endpoint}`);
                const data = await response.json();
                if (!data.success) throw new Error(data.message);
                return data.prompt;
            },
            
            updatePrompt: async (prompt, username = 'admin') => {
                const response = await fetch(`${API_BASE}/admin/config/prompt`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, username })
                });
                const data = await response.json();
                if (!data.success) throw new Error(data.message);
                return true;
            }
        };
        
        // Login Component
        const Login = function(props) {
            const onLogin = props.onLogin;
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');

                try {
                    const response = await api.login(username, password);
                    if (response.success) {
                        onLogin(username, response.role === 'admin', response.name);
                    } else {
                        setError('Credenciais inválidas');
                    }
                } catch (err) {
                    setError('Erro ao fazer login');
                    console.error('Erro:', err);
                }
            };

            return (
                <div className="login-screen">
                    <div className="login-box">
                        <h1 className="login-title">Horizont IA</h1>
                        <form onSubmit={handleSubmit}>
                            <input
                                type="text"
                                className="login-input"
                                placeholder="Usuário"
                                value={username}
                                onChange={(e) => setUsername(e.target.value)}
                            />
                            <input
                                type="password"
                                className="login-input"
                                placeholder="Senha"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                            />
                            <button type="submit" className="login-btn">
                                Entrar
                            </button>
                            {error && <div className="login-error">{error}</div>}
                        </form>
                    </div>
                </div>
            );
        };
        
        // Presentation Modal
        const PresentationModal = function(props) {
            const isOpen = props.isOpen;
            const onClose = props.onClose;
            const chatData = props.chatData;
            const username = props.username;
            const [clientName, setClientName] = useState('');
            
            if (!isOpen) return null;
            
            const generatePDF = async () => {
                const jsPDF = window.jspdf.jsPDF;
                const pdf = new jsPDF();
                
                // Header
                pdf.setFontSize(24);
                pdf.setTextColor(16, 163, 127);
                pdf.text('Horizont Investimentos', 105, 30, { align: 'center' });
                
                pdf.setFontSize(16);
                pdf.setTextColor(0, 0, 0);
                pdf.text('Proposta de Investimento', 105, 45, { align: 'center' });
                
                // Client info
                pdf.setFontSize(12);
                pdf.text(`Cliente: ${clientName || 'Cliente'}`, 20, 70);
                pdf.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 80);
                
                // Extract calculations
                let yPos = 100;
                const messages = chatData && chatData.messages ? chatData.messages : [];
                
                messages.forEach(msg => {
                    if (msg.role === 'assistant' && msg.content.includes('R$')) {
                        const lines = pdf.splitTextToSize(msg.content.substring(0, 500), 170);
                        lines.forEach(line => {
                            if (yPos > 270) {
                                pdf.addPage();
                                yPos = 20;
                            }
                            pdf.text(line, 20, yPos);
                            yPos += 7;
                        });
                    }
                });
                
                pdf.save(`proposta-horizont-${clientName || 'cliente'}.pdf`);
            };
            
            const shareWhatsApp = () => {
                const messages = chatData && chatData.messages ? chatData.messages : [];
                let summary = `🏢 *Horizont Investimentos*\n\n`;
                summary += `📊 Proposta para ${clientName || 'Cliente'}\n\n`;
                
                // Extract key numbers
                for (const msg of messages) {
                    if (msg.role === 'assistant') {
                        const matches = msg.content.match(/R\$\s*[\d.,]+/g);
                        if (matches && matches.length > 0) {
                            summary += `💰 Valores encontrados:\n`;
                            matches.slice(0, 5).forEach(match => {
                                summary += `• ${match}\n`;
                            });
                            break; // Now break works with for...of
                        }
                    }
                }
                
                summary += `\n📱 Gerado pelo Horizont IA`;
                
                const url = `https://wa.me/?text=${encodeURIComponent(summary)}`;
                window.open(url, '_blank');
            };
            
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">Gerar Proposta</h2>
                            <button className="modal-close" onClick={onClose}>✕</button>
                        </div>
                        
                        <input
                            type="text"
                            className="modal-input"
                            placeholder="Nome do cliente"
                            value={clientName}
                            onChange={(e) => setClientName(e.target.value)}
                        />
                        
                        <div className="modal-actions">
                            <button className="modal-btn" onClick={generatePDF}>
                                📄 Gerar PDF
                            </button>
                            <button className="modal-btn secondary" onClick={shareWhatsApp}>
                                📱 Enviar WhatsApp
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        
        // Prompt Manager Component
        const PromptManager = () => {
            const [prompt, setPrompt] = useState('');
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');

            useEffect(() => {
                loadPrompt();
            }, []);

            const loadPrompt = async () => {
                try {
                    const response = await api.getPrompt();
                    setPrompt(response);
                } catch (error) {
                    setError('Erro ao carregar o prompt');
                    console.error('Erro:', error);
                } finally {
                    setLoading(false);
                }
            };

            const handleSave = async () => {
                try {
                    setLoading(true);
                    await api.updatePrompt(prompt);
                    setSuccess('Prompt atualizado com sucesso!');
                    setTimeout(() => setSuccess(''), 3000);
                } catch (error) {
                    setError('Erro ao salvar o prompt');
                    console.error('Erro:', error);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="admin-section">
                    <h2>Gerenciar Prompt do Sistema</h2>
                    <textarea
                        className="prompt-textarea"
                        value={prompt}
                        onChange={(e) => setPrompt(e.target.value)}
                        placeholder="Carregando..."
                        disabled={loading}
                        rows={10}
                    />
                    {error && <div className="error-message">{error}</div>}
                    {success && <div className="success-message">{success}</div>}
                    <button 
                        className="save-prompt-btn"
                        onClick={handleSave}
                        disabled={loading}
                    >
                        💾 Salvar Alterações
                    </button>
                </div>
            );
        };

        // User Manager Component
        const UserManager = function(props) {
            const onUserCreated = props.onUserCreated;
            const [newUser, setNewUser] = useState({ username: '', password: '', role: 'user' });
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');

            const handleCreateUser = async () => {
                if (!newUser.username || !newUser.password) {
                    setError('Preencha todos os campos');
                    setTimeout(() => setError(''), 3000);
                    return;
                }

                try {
                    await api.createUser(newUser);
                    setSuccess('Usuário criado com sucesso!');
                    setNewUser({ username: '', password: '', role: 'user' });
                    setTimeout(() => setSuccess(''), 3000);
                    if (onUserCreated) onUserCreated();
                } catch (error) {
                    setError('Erro ao criar usuário');
                    console.error('Erro:', error);
                    setTimeout(() => setError(''), 3000);
                }
            };

            return (
                <div className="admin-section">
                    <h2>Cadastrar Novo Representante</h2>
                    <div className="user-form">
                        <input
                            type="text"
                            className="user-input"
                            placeholder="Nome de usuário"
                            value={newUser.username}
                            onChange={(e) => setNewUser(Object.assign({}, newUser, { username: e.target.value }))}
                        />
                        <input
                            type="password"
                            className="user-input"
                            placeholder="Senha"
                            value={newUser.password}
                            onChange={(e) => setNewUser(Object.assign({}, newUser, { password: e.target.value }))}
                        />
                        <button 
                            className="create-user-btn"
                            onClick={handleCreateUser}
                        >
                            👤 Criar Representante
                        </button>
                        {error && <div className="error-message">{error}</div>}
                        {success && <div className="success-message">{success}</div>}
                    </div>
                </div>
            );
        };

        // Admin Panel Component
        const AdminPanel = function(props) {
            const onClose = props.onClose;
            const [users, setUsers] = useState([]);
            const [selectedUser, setSelectedUser] = useState(null);
            const [userChats, setUserChats] = useState([]);
            const [selectedChat, setSelectedChat] = useState(null);
            const [chatMessages, setChatMessages] = useState([]);
            const [showAdminPanel, setShowAdminPanel] = useState(false);

            useEffect(() => {
                fetchUsers();
            }, []);

            const fetchUsers = async () => {
                try {
                    const response = await api.getUsers();
                    setUsers(response);
                } catch (error) {
                    console.error('Erro ao buscar usuários:', error);
                }
            };

            const handleDeleteUser = async (username) => {
                if (!confirm(`Tem certeza que deseja deletar o representante ${username}?`)) {
                    return;
                }

                try {
                    await api.deleteUser(username);
                    await fetchUsers();
                    if (selectedUser === username) {
                        setSelectedUser(null);
                        setUserChats([]);
                        setSelectedChat(null);
                        setChatMessages([]);
                    }
                } catch (error) {
                    console.error('Erro ao deletar usuário:', error);
                    alert('Erro ao deletar usuário');
                }
            };

            const fetchUserChats = async (username) => {
                try {
                    const response = await api.getChats(username);
                    setUserChats(response);
                    setSelectedUser(username);
                    setSelectedChat(null);
                    setChatMessages([]);
                } catch (error) {
                    console.error('Erro ao buscar chats:', error);
                }
            };

            const viewChatMessages = (chat) => {
                setSelectedChat(chat);
                setChatMessages(chat.messages || []);
            };

            const formatDate = (dateString) => {
                return new Date(dateString).toLocaleString('pt-BR');
            };

            return (
                <div className="admin-panel">
                    <div className="admin-header">
                        <h1>Painel Administrativo</h1>
                        <button className="close-btn" onClick={onClose}>✕</button>
                    </div>

                    <UserManager onUserCreated={fetchUsers} />
                    <PromptManager />

                    <div className="admin-section">
                        <h2>Gerenciar Representantes</h2>
                        <div className="user-list">
                            {users.map(user => (
                                <div key={user.username} className="user-item">
                                    <div className="user-item-info">
                                        <span className="user-item-name">{user.username}</span>
                                        <span className="user-item-role">{user.role}</span>
                                    </div>
                                    <div className="user-actions-btns">
                                        <button 
                                            className="view-chats-btn"
                                            onClick={() => fetchUserChats(user.username)}
                                        >
                                            Ver Conversas
                                        </button>
                                        <button 
                                            className="delete-user-btn"
                                            onClick={() => handleDeleteUser(user.username)}
                                        >
                                            🗑️ Deletar
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {selectedUser && (
                        <div className="admin-section">
                            <h2>Conversas de {selectedUser}</h2>
                            <div className="chat-list admin-chat-list">
                                {userChats.map(chat => (
                                    <div 
                                        key={chat.id} 
                                        className={`chat-item ${selectedChat && selectedChat.id === chat.id ? 'active' : ''}`}
                                        onClick={() => viewChatMessages(chat)}
                                    >
                                        <span className="chat-item-title">{chat.title}</span>
                                        <span className="chat-item-date">
                                            {formatDate(chat.created_at)}
                                        </span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {selectedChat && (
                        <div className="admin-section">
                            <h2>Mensagens da Conversa</h2>
                            <div className="messages-container admin-messages">
                                {chatMessages.map((msg, index) => (
                                    <div key={index} className={`message ${msg.role}`}>
                                        <div className="message-header">
                                            <div className={msg.role === 'user' ? 'user-avatar' : 'assistant-avatar'}>
                                                {msg.role === 'user' ? '👤' : '🎯'}
                                            </div>
                                            <span className="message-role">
                                                {msg.role === 'user' ? selectedUser : 'Consultor Horizont'}
                                            </span>
                                            <span className="message-date">
                                                {formatDate(msg.created_at)}
                                            </span>
                                        </div>
                                        <div className="message-content">
                                            {renderMessage(msg.content)}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        // App Component
        function App() {
            const [isLoggedIn, setIsLoggedIn] = React.useState(false);
            const [username, setUsername] = React.useState('');
            const [isAdmin, setIsAdmin] = React.useState(false);
            const [showAdminPanel, setShowAdminPanel] = React.useState(false);
            const [chats, setChats] = React.useState([]);
            const [currentChat, setCurrentChat] = React.useState(null);
            const [isSidebarOpen, setIsSidebarOpen] = React.useState(false);
            const messagesEndRef = React.useRef(null);
            const fileInputRef = React.useRef(null);
            const [messages, setMessages] = React.useState([]);
            const [newMessage, setNewMessage] = React.useState('');
            const [isLoading, setIsLoading] = React.useState(false);
            const [error, setError] = React.useState(null);
            const [selectedFiles, setSelectedFiles] = React.useState([]);

            // Login handler
            const handleLogin = async (user, isAdminUser, name) => {
                console.log('Login handler chamado:', { user, isAdminUser, name });
                setIsLoggedIn(true);
                setUsername(user);
                setIsAdmin(isAdminUser);
                console.log('Estado atualizado - isAdmin:', isAdminUser);
            };

            // Scroll to bottom of messages
            const scrollToBottom = () => {
                if (messagesEndRef.current) {
                    messagesEndRef.current.scrollIntoView({ behavior: "smooth" });
                }
            };

            React.useEffect(() => {
                scrollToBottom();
            }, [messages]);

            // Load chats on login
            React.useEffect(() => {
                if (isLoggedIn && username) {
                    loadChats();
                }
            }, [isLoggedIn, username]);

            // Toggle sidebar
            const toggleSidebar = () => {
                setIsSidebarOpen(!isSidebarOpen);
            };

            // Load user's chats
            const loadChats = async () => {
                try {
                    const chats = await api.getChats(username);
                    setChats(chats);
                    if (chats && chats.length > 0) {
                        setCurrentChat(chats[0]);
                        setMessages(chats[0].messages || []);
                    }
                } catch (error) {
                    console.error('Erro ao carregar chats:', error);
                    setError('Erro ao carregar chats');
                }
            };

            // Create new chat
            const handleNewChat = async () => {
                try {
                    const newChat = await api.createChat(username);
                    setChats([newChat].concat(chats));
                    setCurrentChat(newChat);
                    setMessages([]);
                    setIsSidebarOpen(false); // Fechar sidebar no mobile após criar chat
                } catch (error) {
                    console.error('Erro ao criar novo chat:', error);
                    setError('Não foi possível criar um novo chat. Por favor, tente novamente.');
                }
            };

            // Delete chat
            const handleDeleteChat = async (chatId) => {
                try {
                    await api.deleteChat(username, chatId);
                    const updatedChats = chats.filter(chat => chat.id !== chatId);
                    setChats(updatedChats);
                    if (currentChat && currentChat.id === chatId) {
                        setCurrentChat(updatedChats[0] || null);
                        setMessages((updatedChats[0] && updatedChats[0].messages) || []);
                    }
                } catch (error) {
                    console.error('Erro ao deletar chat:', error);
                    setError('Não foi possível deletar o chat. Por favor, tente novamente.');
                }
            };

            // Select chat
            const handleSelectChat = (chat) => {
                setCurrentChat(chat);
                setMessages(chat.messages || []);
                setError(null);
                setIsSidebarOpen(false); // Fechar sidebar no mobile após selecionar chat
            };

            // Clear chat context
            const handleClearContext = async () => {
                if (!currentChat) return;
                
                if (confirm('Limpar o contexto do chat? Isso fará o assistente "esquecer" as mensagens anteriores, mas manterá o histórico visível.')) {
                    try {
                        // Limpar mensagens localmente
                        setMessages([]);
                        
                        // Opcional: Limpar contexto no banco (manter histórico visível)
                        // await api.clearChatContext(username, currentChat.id);
                        
                        setError(null);
                    } catch (error) {
                        console.error('Erro ao limpar contexto:', error);
                        setError('Erro ao limpar contexto do chat');
                    }
                }
            };

            // Send message
            const handleSendMessage = async () => {
                if (!newMessage.trim() && selectedFiles.length === 0) return;
                if (!currentChat) return;

                setIsLoading(true);
                setError(null);

                try {
                    // Criar cópia local da mensagem do usuário
                    const userMessage = {
                        role: 'user',
                        content: newMessage,
                        created_at: new Date().toISOString()
                    };

                    // Atualizar mensagens localmente primeiro
                    const updatedMessages = [...messages, userMessage];
                    setMessages(updatedMessages);
                    
                    // Limpar input e arquivos
                    setNewMessage('');
                    setSelectedFiles([]);
                    if (fileInputRef.current) {
                        fileInputRef.current.value = '';
                    }

                    // Enviar mensagem para o servidor
                    const response = await api.sendMessage(
                        username,
                        currentChat.id,
                        userMessage.content,
                        selectedFiles
                    );

                    if (response.success) {
                        // Adicionar resposta do assistente
                        const assistantMessage = {
                            role: 'assistant',
                            content: response.message,
                            created_at: new Date().toISOString()
                        };
                        
                        // Atualizar mensagens com a resposta
                        setMessages(prev => [...prev, assistantMessage]);
                        
                        // Atualizar o chat atual com as novas mensagens
                        setCurrentChat(prevChat => ({
                            ...prevChat,
                            messages: [...updatedMessages, assistantMessage]
                        }));
                        
                        // Atualizar a lista de chats
                        setChats(prevChats => {
                            return prevChats.map(chat => {
                                if (chat.id === currentChat.id) {
                                    return {
                                        ...chat,
                                        messages: [...updatedMessages, assistantMessage]
                                    };
                                }
                                return chat;
                            });
                        });
                    } else {
                        throw new Error('Falha ao enviar mensagem');
                    }

                } catch (error) {
                    console.error('Erro ao enviar mensagem:', error);
                    setError(error.message || 'Não foi possível enviar a mensagem. Por favor, tente novamente.');
                    
                    // Remover a mensagem do usuário em caso de erro
                    setMessages(prev => prev.slice(0, -1));
                } finally {
                    setIsLoading(false);
                }
            };

            // Handle file selection
            const handleFileSelect = (event) => {
                const files = Array.from(event.target.files);
                setSelectedFiles(files);
            };

            // Render main content
            const renderMainContent = () => {
                if (!isLoggedIn) {
                    return React.createElement(Login, {
                        onLogin: handleLogin
                    });
                }

                return React.createElement('div', { className: 'chat-container' }, [
                    // Messages container
                    React.createElement('div', {
                        key: 'messages',
                        className: 'messages'
                    }, [
                        messages.map((msg, index) =>
                            React.createElement('div', {
                                key: `msg-${msg.role}-${index}-${msg.content ? msg.content.substring(0, 10) : 'empty'}`,
                                className: 'message ' + msg.role
                            }, [
                                React.createElement('div', {
                                    key: 'avatar',
                                    className: 'avatar ' + (msg.role === 'user' ? 'user-avatar' : 'assistant-avatar')
                                }),
                                React.createElement('div', {
                                    key: 'content',
                                    className: 'message-content'
                                }, [
                                    React.createElement('div', {
                                        key: 'header',
                                        className: 'message-header'
                                    }, msg.role === 'user' ? 'Você' : 'Assistente'),
                                    renderMessage(msg.content)
                                ])
                            ])
                        ),
                        isLoading &&
                            React.createElement('div', {
                                key: 'loading',
                                className: 'message system'
                            }, [
                                React.createElement('div', {
                                    key: 'avatar',
                                    className: 'avatar system-avatar'
                                }),
                                React.createElement('div', {
                                    key: 'content',
                                    className: 'message-content'
                                }, [
                                    React.createElement('div', {
                                        key: 'header',
                                        className: 'message-header'
                                    }, 'Sistema'),
                                    'Processando...'
                                ])
                            ]),
                        error &&
                            React.createElement('div', {
                                key: 'error',
                                className: 'message system error',
                                onClick: () => setError(null)
                            }, [
                                React.createElement('div', {
                                    key: 'avatar',
                                    className: 'avatar error-avatar'
                                }),
                                React.createElement('div', {
                                    key: 'content',
                                    className: 'message-content'
                                }, [
                                    React.createElement('div', {
                                        key: 'header',
                                        className: 'message-header'
                                    }, 'Erro'),
                                    error
                                ])
                            ]),
                        React.createElement('div', {
                            key: 'end',
                            ref: messagesEndRef
                        })
                    ]),

                    // Input container
                    React.createElement('div', {
                        key: 'input',
                        className: 'input-container'
                    }, [
                        React.createElement('div', {
                            key: 'input-wrapper',
                            className: 'input-wrapper'
                        }, [
                            React.createElement('textarea', {
                                key: 'message-input',
                                className: 'message-input',
                                value: newMessage,
                                onChange: (e) => setNewMessage(e.target.value),
                                onKeyDown: (e) => {
                                    if (e.key === 'Enter' && !e.shiftKey) {
                                        e.preventDefault();
                                        handleSendMessage();
                                    }
                                },
                                placeholder: 'Digite sua mensagem...',
                                disabled: isLoading || !currentChat
                            }),
                            React.createElement('div', {
                                key: 'input-actions',
                                className: 'input-actions'
                            }, [
                                React.createElement('input', {
                                    key: 'file-input',
                                    type: 'file',
                                    ref: fileInputRef,
                                    onChange: handleFileSelect,
                                    multiple: true,
                                    style: { display: 'none' }
                                }),
                                React.createElement('button', {
                                    key: 'attach-button',
                                    className: 'button attach-button',
                                    onClick: () => {
                                        if (fileInputRef.current) {
                                            fileInputRef.current.click();
                                        }
                                    },
                                    disabled: isLoading || !currentChat
                                }, '📎'),
                                React.createElement('button', {
                                    key: 'clear-context',
                                    className: 'button clear-context-btn',
                                    onClick: handleClearContext,
                                    disabled: isLoading || !currentChat,
                                    title: 'Limpar contexto (manter histórico)'
                                }, '🧹'),
                                React.createElement('button', {
                                    key: 'send-button',
                                    className: 'button send-button',
                                    onClick: handleSendMessage,
                                    disabled: isLoading || !currentChat || (!newMessage.trim() && selectedFiles.length === 0)
                                }, '➤')
                            ])
                        ]),
                        selectedFiles.length > 0 && React.createElement('div', {
                            key: 'selected-files',
                            className: 'selected-files'
                        }, [
                            React.createElement('div', {
                                key: 'files-list',
                                className: 'files-list'
                            }, selectedFiles.map((file, index) => 
                                React.createElement('div', {
                                    key: `file-${file.name}-${index}`,
                                    className: 'file-item'
                                }, [
                                    file.name,
                                    React.createElement('button', {
                                        key: 'remove-file',
                                        className: 'remove-file',
                                        onClick: () => {
                                            const newFiles = selectedFiles.filter((_, i) => i !== index);
                                            setSelectedFiles(newFiles);
                                            if (newFiles.length === 0 && fileInputRef.current) {
                                                fileInputRef.current.value = '';
                                            }
                                        }
                                    }, '×')
                                ])
                            ))
                        ])
                    ])
                ]);
            };

            // Render sidebar content
            const renderSidebar = () => {
                return [
                    React.createElement('div', {
                        key: 'header',
                        className: 'sidebar-header'
                    }, [
                        React.createElement('div', {
                            key: 'logo',
                            className: 'sidebar-logo'
                        }, '💼 Horizont IA'),
                        React.createElement('div', {
                            key: 'user',
                            className: 'user-info'
                        }, [
                            `Bem-vindo, ${username}!`,
                            React.createElement('div', {
                                key: 'actions',
                                className: 'user-actions'
                            }, [
                                // Só mostrar botão admin se o usuário for admin
                                isAdmin && React.createElement('button', {
                                    key: 'admin',
                                    className: 'admin-btn',
                                    onClick: () => setShowAdminPanel(true)
                                }, '⚙️ Admin'),
                                React.createElement('button', {
                                    key: 'logout',
                                    className: 'logout-btn',
                                    onClick: () => {
                                        setIsLoggedIn(false);
                                        setUsername('');
                                        setChats([]);
                                        setCurrentChat(null);
                                        setMessages([]);
                                    }
                                }, '🚪 Sair')
                            ])
                        ])
                    ]),
                    React.createElement('button', {
                        key: 'new-chat',
                        className: 'new-chat-btn',
                        onClick: handleNewChat
                    }, '+ Nova Conversa'),
                    React.createElement('div', {
                        key: 'list',
                        className: 'chat-list'
                    }, chats.map(chat =>
                        React.createElement('div', {
                            key: chat.id,
                            className: 'chat-item' + ((currentChat && currentChat.id === chat.id) ? ' active' : ''),
                            onClick: () => handleSelectChat(chat)
                        }, [
                            React.createElement('span', {
                                key: 'title',
                                className: 'chat-item-title'
                            }, chat.title || 'Nova Conversa'),
                            React.createElement('button', {
                                key: 'delete',
                                className: 'delete-chat-btn',
                                onClick: (e) => {
                                    e.stopPropagation();
                                    handleDeleteChat(chat.id);
                                }
                            }, '🗑️')
                        ])
                    ))
                ];
            };

            return React.createElement('div', { 
                className: 'app' + (!isLoggedIn ? ' login-mode' : '')
            }, [
                // Admin Panel
                showAdminPanel && React.createElement(AdminPanel, {
                    key: 'admin-panel',
                    onClose: () => setShowAdminPanel(false)
                }),
                
                // Menu toggle button for mobile - only show if logged in
                isLoggedIn && React.createElement('button', {
                    key: 'menu-toggle',
                    className: 'menu-toggle visible',
                    onClick: toggleSidebar
                }, '☰'),
                
                // Sidebar overlay - only show if logged in
                isLoggedIn && React.createElement('div', {
                    key: 'sidebar-overlay',
                    className: 'sidebar-overlay' + (isSidebarOpen ? ' show' : ''),
                    onClick: () => setIsSidebarOpen(false)
                }),
                
                // Sidebar - only show if logged in
                isLoggedIn && React.createElement('div', {
                    key: 'sidebar',
                    className: 'sidebar' + (isSidebarOpen ? ' open' : '')
                }, renderSidebar()),
                
                // Main content
                React.createElement('div', {
                    key: 'main',
                    className: isLoggedIn ? 'main-content' : ''
                }, renderMainContent())
            ]);
        }
        
        // Render App
        ReactDOM.render(
            React.createElement(App),
            document.getElementById('root')
        );
    </script>
</body>
</html>